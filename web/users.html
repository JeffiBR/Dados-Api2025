<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciar Usuários - Preços AL</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="designer.css">
    <link rel="stylesheet" href="componentes.css">
    <link rel="stylesheet" href="users.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="auth.js"></script>
    <script src="menu.js"></script>
    <script src="theme.js"></script>
    <style>
        /* Estilos para modais */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            overflow-y: auto;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: var(--panel-dark);
            margin: 2% auto;
            border-radius: 12px;
            border: 1px solid var(--border-dark);
            width: 90%;
            max-width: 1000px;
            box-shadow: 0 10px 50px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease;
        }

        body.light-mode .modal-content {
            background: var(--panel-light);
            border: 1px solid var(--border-light);
        }

        @keyframes modalSlideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--border-dark);
        }

        body.light-mode .modal-header {
            border-bottom: 1px solid var(--border-light);
        }

        .modal-header h3 {
            margin: 0;
            color: var(--text-dark);
            font-size: 1.4rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .modal-header h3::before {
            content: '';
            width: 4px;
            height: 24px;
            background: var(--primary);
            border-radius: 2px;
        }

        body.light-mode .modal-header h3 {
            color: var(--text-light);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--muted-dark);
            cursor: pointer;
            transition: var(--transition);
        }

        body.light-mode .modal-close {
            color: var(--muted-light);
        }

        .modal-close:hover {
            color: var(--error);
            transform: scale(1.1);
        }

        .modal-body {
            padding: 2rem;
            max-height: 70vh;
            overflow-y: auto;
        }

        .modal-footer {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            padding: 1.5rem 2rem;
            border-top: 1px solid var(--border-dark);
        }

        body.light-mode .modal-footer {
            border-top: 1px solid var(--border-light);
        }

        /* Cards de ação */
        .action-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .action-card {
            background: var(--panel-dark);
            border-radius: 12px;
            border: 1px solid var(--border-dark);
            padding: 2rem;
            transition: var(--transition);
            cursor: pointer;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        body.light-mode .action-card {
            background: var(--panel-light);
            border: 1px solid var(--border-light);
        }

        .action-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
            border-color: var(--primary);
        }

        .action-icon {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.8rem;
            box-shadow: 0 8px 25px color-mix(in srgb, var(--primary) 30%, transparent);
        }

        .action-card h3 {
            color: var(--text-dark);
            font-size: 1.3rem;
            font-weight: 600;
            margin: 0;
        }

        body.light-mode .action-card h3 {
            color: var(--text-light);
        }

        .action-card p {
            color: var(--muted-dark);
            margin: 0;
            line-height: 1.5;
        }

        body.light-mode .action-card p {
            color: var(--muted-light);
        }

        /* Responsividade */
        @media (max-width: 768px) {
            .modal-content {
                width: 95%;
                margin: 5% auto;
            }
            
            .modal-body {
                padding: 1.5rem;
                max-height: 80vh;
            }
            
            .modal-header, .modal-footer {
                padding: 1.5rem;
            }
            
            .modal-footer {
                flex-direction: column;
            }
            
            .modal-footer .btn {
                width: 100%;
            }
            
            .action-cards {
                grid-template-columns: 1fr;
            }
        }

        /* Melhorias para tabelas em mobile */
        .table-responsive {
            overflow-x: auto;
        }
        
        @media (max-width: 768px) {
            table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }
            
            .user-info-cell {
                flex-direction: column;
                text-align: center;
                gap: 0.5rem;
            }
            
            .actions {
                justify-content: center;
            }
        }
    </style>
</head>
<body class="theme-dark">
    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            if (!await requireAuth()) return;
            await initializeDynamicMenu();
            await checkAccessExpiration();
            routeGuard('users');
        });
    </script>

    <div class="app-container">
        <aside class="sidebar" id="sidebarMenu">
            <div class="sidebar-header">
                <i class="fas fa-bolt"></i>
                <h1>Preços AL</h1>
            </div>
            <nav class="sidebar-nav">
                <ul>
                    <li class="nav-header">ANÁLISE</li>
                    <li><a href="/search.html"><i class="fas fa-search"></i> Busca</a></li>
                    <li data-required-permission="compare"><a href="/compare.html"><i class="fas fa-chart-bar"></i> Comparador</a></li>
                    <li data-required-permission="dashboard"><a href="/dashboard.html"><i class="fas fa-chart-line"></i> Dashboard</a></li>
                    <li data-required-permission="baskets"><a href="/cesta.html"><i class="fas fa-shopping-basket"></i> Minhas Cestas</a></li>
                    
                    <li class="nav-header">ADMINISTRAÇÃO</li>
                    <li data-required-permission="coleta"><a href="/admin.html"><i class="fas fa-database"></i> Coleta</a></li>
                    <li data-required-permission="collections"><a href="/collections.html"><i class="fas fa-history"></i> Histórico de Coletas</a></li>
                    <li data-required-permission="product_log"><a href="/product-log.html"><i class="fas fa-file-alt"></i> Log de Produtos</a></li>
                    <li data-required-permission="user_logs"><a href="/user-logs.html"><i class="fas fa-user-clock"></i> Logs de Usuários</a></li>
                    <li data-required-permission="prune"><a href="/prune.html"><i class="fas fa-broom"></i> Limpeza de Dados</a></li>

                    <li class="nav-header">CONFIGURAÇÃO</li>
                    <li data-required-permission="markets"><a href="/markets.html"><i class="fas fa-store"></i> Gerenciar Mercados</a></li>
                    <li data-required-permission="users"><a href="/users.html" class="active"><i class="fas fa-users"></i> Gerenciar Usuários</a></li>
                    <li><a href="/group-users.html"><i class="fas fa-user-friends"></i> Meus Grupos</a></li>
                </ul>
            </nav>
            <div class="theme-switcher">
                <span>Tema</span>
                <button id="themeToggle"><i class="fas fa-moon"></i></button>
            </div>
        </aside>

        <div class="sidebar-overlay" id="sidebarOverlay"></div>

        <div class="main-content">
            <header class="top-bar">
                <div class="top-bar-left"><button class="mobile-menu-btn" id="mobileMenuBtn"><span></span><span></span><span></span></button></div>
                <div class="top-bar-right"><div class="user-menu" id="userMenu"><button class="user-menu-btn" id="userMenuBtn"><div class="user-avatar"><img src="https://ui-avatars.com/api/?name=U" alt="User" id="userAvatar"></div><div class="user-info"><span class="user-name">Usuário</span><span class="user-role">...</span></div><i class="fas fa-chevron-down"></i></button><div class="user-dropdown" id="userDropdown"><a href="/profile.html" class="dropdown-item"><i class="fas fa-user"></i><span>Meu Perfil</span></a><div class="dropdown-divider"></div><a href="#" class="dropdown-item logout-btn" id="logoutBtn"><i class="fas fa-sign-out-alt"></i><span>Sair</span></a></div></div></div>
            </header>
            
            <div class="page-content">
                <div class="page-header">
                    <div class="page-title">
                        <h1><i class="fas fa-users-cog"></i>Gerenciar Usuários</h1>
                        <p>Crie, edite e defina permissões para os usuários do sistema.</p>
                    </div>
                </div>

                <!-- Cards de Ação em vez de Tabs -->
                <div class="action-cards">
                    <div class="action-card" id="users-card">
                        <div class="action-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <h3>Gerenciar Usuários</h3>
                        <p>Crie, edite e exclua usuários do sistema e defina suas permissões.</p>
                    </div>
                    
                    <div class="action-card" id="groups-card">
                        <div class="action-icon">
                            <i class="fas fa-layer-group"></i>
                        </div>
                        <h3>Grupos de Acesso</h3>
                        <p>Gerencie grupos de usuários e suas permissões de acesso.</p>
                    </div>
                    
                    <div class="action-card" id="associations-card">
                        <div class="action-icon">
                            <i class="fas fa-link"></i>
                        </div>
                        <h3>Associações</h3>
                        <p>Associe usuários a grupos e defina datas de expiração.</p>
                    </div>
                    
                    <div class="action-card" id="admin-groups-card">
                        <div class="action-icon">
                            <i class="fas fa-chart-pie"></i>
                        </div>
                        <h3>Visão Admin</h3>
                        <p>Visualize todos os grupos e usuários do sistema.</p>
                    </div>
                </div>

                <!-- Tabela de Usuários (visível por padrão) -->
                <div class="card table-container" style="margin-top: 2rem;">
                    <div class="card-header">
                        <h3><i class="fas fa-list"></i>Usuários Cadastrados</h3>
                        <button class="btn btn-primary" id="addUserBtn">
                            <i class="fas fa-user-plus"></i> Adicionar Usuário
                        </button>
                    </div>
                    <div class="card-content">
                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Usuário</th>
                                        <th>Senha</th>
                                        <th>Nível</th>
                                        <th>Permissões</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="usersTableBody">
                                    <!-- Usuários serão carregados aqui -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para Gerenciar Usuários -->
    <div id="users-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-users"></i>Gerenciar Usuários</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Formulário de Usuário -->
                <div class="card form-container">
                    <h3 id="formTitle">Adicionar Novo Usuário</h3>
                    <input type="hidden" id="userId">
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="fullName">Nome Completo *</label>
                            <input type="text" id="fullName" placeholder="Digite o nome completo" required>
                        </div>
                        <div class="form-group">
                            <label for="email">Email *</label>
                            <input type="email" id="email" placeholder="Digite o email" required>
                        </div>
                        <div class="form-group">
                            <label for="password">Senha *</label>
                            <input type="password" id="password" placeholder="Mínimo 6 caracteres" required>
                        </div>
                        <div class="form-group">
                            <label for="role">Nível de Acesso</label>
                            <select id="role">
                                <option value="user">Usuário</option>
                                <option value="group_admin">Admin de Grupo</option>
                                <option value="admin">Admin Geral</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group full-width">
                        <label>Permissões de Página (para nível 'Usuário')</label>
                        <div id="permissions-container" class="permissions-grid">
                            <!-- Permissões serão carregadas aqui -->
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button id="saveUserBtn" class="btn btn-primary btn-create">
                            <i class="fas fa-user-plus"></i>Criar Usuário
                        </button>
                        <button id="cancelButton" class="btn btn-secondary" style="display:none;">
                            <i class="fas fa-times"></i>Cancelar
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary close-modal">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Modal para Grupos de Acesso -->
    <div id="groups-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-layer-group"></i>Grupos de Acesso</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="card form-container">
                    <h3 id="groupFormTitle">Criar Novo Grupo</h3>
                    <input type="hidden" id="groupId">
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="groupName">Nome do Grupo</label>
                            <input type="text" id="groupName" placeholder="Digite o nome do grupo">
                        </div>
                        <div class="form-group">
                            <label for="accessDays">Dias de Acesso</label>
                            <input type="number" id="accessDays" placeholder="30" min="1" max="365" value="30">
                        </div>
                        <div class="form-group">
                            <label for="maxUsers">Máximo de Usuários</label>
                            <input type="number" id="maxUsers" placeholder="10" min="1" max="1000" value="10">
                        </div>
                        <div class="form-group">
                            <label for="groupAdmin">Admin do Grupo</label>
                            <select id="groupAdmin">
                                <option value="">Selecione um administrador</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group full-width">
                        <label for="groupDescription">Descrição</label>
                        <textarea id="groupDescription" placeholder="Descrição opcional do grupo" rows="3"></textarea>
                    </div>
                    
                    <div class="form-actions">
                        <button id="saveGroupBtn" class="btn btn-primary">
                            <i class="fas fa-save"></i> Salvar Grupo
                        </button>
                        <button id="cancelGroupButton" class="btn btn-secondary" style="display:none;">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                    </div>
                </div>

                <div class="card table-container" style="margin-top: 2rem;">
                    <div class="card-header">
                        <h3><i class="fas fa-layer-group"></i>Grupos Cadastrados</h3>
                    </div>
                    <div class="card-content">
                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Nome</th>
                                        <th>Admin</th>
                                        <th>Dias de Acesso</th>
                                        <th>Usuários</th>
                                        <th>Descrição</th>
                                        <th>Criado em</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="groupsTableBody">
                                    <!-- Grupos serão carregados aqui -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary close-modal">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Modal para Associações -->
    <div id="associations-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-link"></i>Associações</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="card form-container">
                    <h3><i class="fas fa-link"></i>Adicionar Usuário ao Grupo</h3>
                    
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="userSelect">Usuário</label>
                            <select id="userSelect">
                                <option value="">Selecione um usuário</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="groupSelect">Grupo</label>
                            <select id="groupSelect">
                                <option value="">Selecione um grupo</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="expirationDate">Data de Expiração (opcional)</label>
                            <input type="date" id="expirationDate">
                            <small>Se não informado, será calculada automaticamente baseada nos dias de acesso do grupo</small>
                        </div>
                    </div>
                    
                    <div class="form-actions">
                        <button id="addUserToGroupBtn" class="btn btn-primary">
                            <i class="fas fa-user-plus"></i> Adicionar ao Grupo
                        </button>
                    </div>
                </div>

                <div class="card table-container" style="margin-top: 2rem;">
                    <div class="card-header">
                        <h3><i class="fas fa-list-check"></i>Associações Usuário-Grupo</h3>
                    </div>
                    <div class="card-content">
                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Usuário</th>
                                        <th>Email</th>
                                        <th>Grupo</th>
                                        <th>Data de Expiração</th>
                                        <th>Status</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="userGroupsTableBody">
                                    <!-- Associações serão carregadas aqui -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary close-modal">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Modal para Visão Admin -->
    <div id="admin-groups-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-chart-pie"></i>Visão Admin</h3>
                <button class="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <div class="card">
                    <div class="card-header">
                        <h3><i class="fas fa-chart-pie"></i>Visão Geral de Grupos</h3>
                    </div>
                    <div class="card-content">
                        <div class="tabs">
                            <button class="tab-button active" data-subtab="all-groups-tab">Todos os Grupos</button>
                            <button class="tab-button" data-subtab="group-users-tab">Usuários por Grupo</button>
                        </div>
                        
                        <div id="all-groups-tab" class="subtab-content active">
                            <div class="table-responsive">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Nome</th>
                                            <th>Admin</th>
                                            <th>Dias de Acesso</th>
                                            <th>Usuários</th>
                                            <th>Máximo</th>
                                            <th>Status</th>
                                            <th>Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody id="allGroupsTableBody">
                                        <!-- Todos os grupos serão carregados aqui -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        <div id="group-users-tab" class="subtab-content">
                            <div class="form-group">
                                <label for="filterGroupSelect">Filtrar por Grupo:</label>
                                <select id="filterGroupSelect">
                                    <option value="">Todos os grupos</option>
                                </select>
                            </div>
                            <div class="table-responsive">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Grupo</th>
                                            <th>Usuário</th>
                                            <th>Email</th>
                                            <th>Data de Expiração</th>
                                            <th>Status</th>
                                            <th>Permissões</th>
                                        </tr>
                                    </thead>
                                    <tbody id="allGroupUsersTableBody">
                                        <!-- Todos os usuários por grupo serão carregados aqui -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary close-modal">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Scripts JavaScript -->
    <script src="users.js"></script>
    <script src="groups.js"></script>
    <script src="user-menu.js"></script>
    <script src="user-activity-monitor.js"></script>
    <script src="mobile-menu.js"></script>

    <script>
        // Controle dos modais
        document.addEventListener('DOMContentLoaded', function() {
            // Elementos dos modais
            const usersModal = document.getElementById('users-modal');
            const groupsModal = document.getElementById('groups-modal');
            const associationsModal = document.getElementById('associations-modal');
            const adminGroupsModal = document.getElementById('admin-groups-modal');
            
            // Botões para abrir modais
            const usersCard = document.getElementById('users-card');
            const groupsCard = document.getElementById('groups-card');
            const associationsCard = document.getElementById('associations-card');
            const adminGroupsCard = document.getElementById('admin-groups-card');
            const addUserBtn = document.getElementById('addUserBtn');
            
            // Botões para fechar modais
            const closeButtons = document.querySelectorAll('.modal-close, .close-modal');
            
            // Função para abrir modal
            function openModal(modal) {
                modal.style.display = 'block';
                document.body.style.overflow = 'hidden'; // Previne scroll no body
            }
            
            // Função para fechar modal
            function closeModal(modal) {
                modal.style.display = 'none';
                document.body.style.overflow = 'auto'; // Restaura scroll no body
            }
            
            // Event listeners para abrir modais
            usersCard.addEventListener('click', () => openModal(usersModal));
            groupsCard.addEventListener('click', () => openModal(groupsModal));
            associationsCard.addEventListener('click', () => openModal(associationsModal));
            adminGroupsCard.addEventListener('click', () => openModal(adminGroupsModal));
            addUserBtn.addEventListener('click', () => openModal(usersModal));
            
            // Event listeners para fechar modais
            closeButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const modal = this.closest('.modal');
                    closeModal(modal);
                });
            });
            
            // Fechar modal ao clicar fora do conteúdo
            window.addEventListener('click', function(event) {
                if (event.target.classList.contains('modal')) {
                    closeModal(event.target);
                }
            });
            
            // Fechar modal com tecla ESC
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Escape') {
                    const modals = document.querySelectorAll('.modal');
                    modals.forEach(modal => {
                        if (modal.style.display === 'block') {
                            closeModal(modal);
                        }
                    });
                }
            });
            
            // Controlar subtabs no modal de admin
            const subtabButtons = document.querySelectorAll('[data-subtab]');
            subtabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const subtabId = this.getAttribute('data-subtab');
                    
                    // Remove classe active de todos os botões e conteúdos
                    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                    document.querySelectorAll('.subtab-content').forEach(content => content.classList.remove('active'));
                    
                    // Adiciona classe active ao botão clicado e ao conteúdo correspondente
                    this.classList.add('active');
                    document.getElementById(subtabId).classList.add('active');
                });
            });
        });
    </script>
</body>
</html>
